<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Event Assistant</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b5cf6; /* Violet */
            --primary-dark: #7c3aed;
            --secondary: #ec4899; /* Pink */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Manrope', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Animated background */
        .bg-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.4;
            animation: float 20s infinite alternate;
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 50vw;
            height: 50vw;
            background: var(--primary);
            animation-delay: 0s;
        }

        .blob-2 {
            bottom: -10%;
            right: -10%;
            width: 50vw;
            height: 50vw;
            background: var(--secondary);
            animation-delay: -10s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(5%, 5%) scale(1.1); }
        }

        .navbar {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span { font-size: 1.8rem; -webkit-text-fill-color: initial; }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1.2;
            background: linear-gradient(135deg, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-section {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(139, 92, 246, 0.25);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 92, 246, 0.4);
        }

        .btn-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        thead {
            background: rgba(15, 23, 42, 0.5);
        }

        th {
            padding: 1.25rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        td {
            padding: 1.25rem 1.5rem;
            color: var(--text);
            font-size: 0.95rem;
        }

        .ip-badge {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .ip-badge:hover {
            background: rgba(99, 102, 241, 0.3);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: #1e293b;
            max-width: 500px;
            margin: 10vh auto;
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .info-grid {
            display: grid;
            gap: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-key {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .info-val {
            font-weight: 500;
            text-align: right;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .btn-group {
                flex-direction: column;
            }
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .btn-group {
                width: 100%;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="bg-fixed">
        <div class="bg-blob blob-1"></div>
        <div class="bg-blob blob-2"></div>
    </div>

    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo"><span>üé´</span> Event Assistant</div>
            <div class="user-menu">
                <button class="logout-btn" onclick="logout()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    –í—ã—Ö–æ–¥
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-label">üìä –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayCount">-</div>
                <div class="stat-label">üìÖ –ó–∞ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uniqueIPs">-</div>
                <div class="stat-label">üåç –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö IP</div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-header">
                <h2 class="section-title">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="loadData()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        –≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>
            </div>
            <div id="tableContainer" class="table-container"></div>
        </div>
    </div>

    <div id="ipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üåê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± IP</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="ipInfoContainer"></div>
        </div>
    </div>

    <script>
        // Auth check
        const token = localStorage.getItem('authToken');
        if (!token) window.location.href = '/admin/login.html';

        async function loadData() {
            const btn = document.querySelector('.btn-primary');
            btn.disabled = true;
            btn.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const response = await fetch('/api/submissions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                // Update stats
                animateValue('totalCount', data.length);

                const today = new Date().toISOString().split('T')[0];
                const todayCount = data.filter(s => s.timestamp.startsWith(today)).length;
                animateValue('todayCount', todayCount);

                const uniqueIPs = new Set(data.map(s => s.ip)).size;
                animateValue('uniqueIPs', uniqueIPs);

                // Render table
                renderTable(data);
            } catch (error) {
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    –û–±–Ω–æ–≤–∏—Ç—å
                `;
            }
        }

        function animateValue(id, value) {
            const obj = document.getElementById(id);
            const start = parseInt(obj.innerHTML) || 0;
            if (start === value) {
                obj.innerHTML = value;
                return;
            }

            let current = start;
            const range = value - start;
            const increment = value > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(1000 / range));
            const timer = setInterval(() => {
                current += increment;
                obj.innerHTML = current;
                if (current == value) clearInterval(timer);
            }, Math.max(stepTime, 20));
        }

        function renderTable(data) {
            const container = document.getElementById('tableContainer');

            if (data.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 4rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>IP –ê–¥—Ä–µ—Å</th>
                            <th>User Agent</th>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td style="font-weight: 500;">${row.email}</td>
                                <td>
                                    <span class="ip-badge" onclick="showIPInfo('${row.ip}')">
                                        ${row.ip}
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                    </span>
                                </td>
                                <td style="color: var(--text-muted); font-size: 0.85rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${row.user_agent}">
                                    ${row.user_agent}
                                </td>
                                <td style="font-family: monospace; color: var(--text-muted);">
                                    ${new Date(row.timestamp).toLocaleString('ru-RU')}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function showIPInfo(ip) {
            const modal = document.getElementById('ipModal');
            const container = document.getElementById('ipInfoContainer');

            modal.style.display = 'block';
            // Force reflow
            modal.offsetHeight;
            modal.classList.add('show');

            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--text-muted);">–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            `;

            try {
                // Use HTTPS if possible, or try via proxy if mixed content block
                const response = await fetch(`http://ip-api.com/json/${ip}?fields=status,message,country,countryCode,regionName,city,zip,lat,lon,timezone,isp,org,as,query`);
                const data = await response.json();

                if (data.status === 'success') {
                    container.innerHTML = `
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-key">IP –ê–¥—Ä–µ—Å</span>
                                <span class="info-val">${data.query}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-key">–°—Ç—Ä–∞–Ω–∞</span>
                                <span class="info-val">${data.country} ${data.countryCode}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-key">–ì–æ—Ä–æ–¥</span>
                                <span class="info-val">${data.city}, ${data.regionName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-key">–ü—Ä–æ–≤–∞–π–¥–µ—Ä (ISP)</span>
                                <span class="info-val">${data.isp}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-key">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</span>
                                <span class="info-val">${data.org}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-key">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</span>
                                <span class="info-val">${data.timezone}</span>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem; height: 200px; background: rgba(0,0,0,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                            <a href="https://www.google.com/maps?q=${data.lat},${data.lon}" target="_blank" style="color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                                –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                            </a>
                        </div>
                    `;
                } else {
                    throw new Error('API Error');
                }
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--danger); padding: 2rem;">
                        <p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</p>
                        <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem;">–í–æ–∑–º–æ–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ mixed content –∏–ª–∏ API –ª–∏–º–∏—Ç</p>
                    </div>
                `;
            }
        }

        function closeModal() {
            const modal = document.getElementById('ipModal');
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('ipModal');
            if (event.target === modal) closeModal();
        }

        async function exportData() {
            try {
                const response = await fetch('/api/export', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) return logout();

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `submissions_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ');
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/admin/login.html';
        }

        // Initial load
        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
